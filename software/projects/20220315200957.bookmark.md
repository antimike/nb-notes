# Idea for iPython extension to use FZF (github.com)

<https://github.com/infokiller/config-public/blob/master/.config/ipython/profile_default/startup/ext/fzf_history.py>

## Description

Linux/WSL config to optimize ergonomics, security, and productivity: vim/neovim, zsh, tmux, i3, emacs, vscode, ipython, jupyter, ranger, fzf, kitty, xkb, selfquant, firejail, systemd, etc - config-public/fzf_history.py at master · infokiller/config-public

## Tags

#fzf #ipython

## Content

[Skip to content](#start-of-content){.px-2 .py-4 .color-bg-accent-emphasis .color-fg-on-emphasis .show-on-focus .js-skip-to-content}

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo){.d-inline-block .d-lg-none .f5 .no-underline .border .color-border-default .rounded-2 .px-2 .py-1 .mr-3 .mr-sm-5 .color-fg-inherit}

-   Product
    -   [Features](/features){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--primary .text-bold .py-2}
    -   [Mobile](/mobile){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--secondary .py-2}
    -   [Actions](/features/actions){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--secondary .py-2}
    -   [Codespaces](/features/codespaces){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--secondary .py-2}
    -   [Packages](/features/packages){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--secondary .py-2}
    -   [Security](/features/security){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--secondary .py-2}
    -   [Code review](/features/code-review){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--secondary .py-2}
    -   [Issues](/features/issues){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--secondary .py-2}
    -   [Integrations](/features/integrations){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--secondary .py-2}
    -   [GitHub Sponsors](/sponsors){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--primary .text-bold .border-top .pt-4 .pb-2 .mt-3}
    -   [Customer stories](/customer-stories){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--primary .text-bold .py-2}
-   [Team](/team){.HeaderMenu-link .no-underline .py-3 .d-block .d-lg-inline-block}
-   [Enterprise](/enterprise){.HeaderMenu-link .no-underline .py-3 .d-block .d-lg-inline-block}
-   Explore
    -   [Explore GitHub](/explore){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--primary .text-bold .py-2}
    -   Learn and contribute
    -   [Topics](/topics){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--secondary .py-2}
    -   [Collections](/collections){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--secondary .py-2}
    -   [Trending](/trending){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--secondary .py-2}
    -   [Learning Lab](https://lab.github.com/){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--secondary .py-2}
    -   [Open source guides](https://opensource.guide){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--secondary .py-2}
    -   Connect with others
    -   [The ReadME Project](/readme){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--secondary .py-2}
    -   [Events](/events){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--secondary .py-2}
    -   [Community forum](https://github.community){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--secondary .py-2}
    -   [GitHub Education](https://education.github.com){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--secondary .py-2}
    -   [GitHub Stars program](https://stars.github.com){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--secondary .py-2}
-   [Marketplace](/marketplace){.HeaderMenu-link .no-underline .py-3 .d-block .d-lg-inline-block}
-   Pricing
    -   [Plans](/pricing){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--primary .text-bold .py-2}
    -   [Compare plans](/pricing#compare-features){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--secondary .py-2}
    -   [Contact Sales](https://github.com/enterprise/contact){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--secondary .py-2}
    -   [Education](https://education.github.com){.lh-condensed-ultra .d-block .no-underline .position-relative .Link--primary .text-bold .border-top .pt-4 .pb-2 .mt-3}

```{=html}
<!-- -->
```
-   [](){.no-underline .d-flex .flex-auto .flex-items-center .jump-to-suggestions-path .js-jump-to-suggestion-path .js-navigation-open .p-2}
    ![](){.avatar .mr-2 .flex-shrink-0 .js-jump-to-suggestion-avatar .d-none width="28" height="28"}
    In this repository
    All GitHub
    ↵
    Jump to
    ↵

```{=html}
<!-- -->
```
-   No suggested jump to results

```{=html}
<!-- -->
```
-   [](){.no-underline .d-flex .flex-auto .flex-items-center .jump-to-suggestions-path .js-jump-to-suggestion-path .js-navigation-open .p-2}
    ![](){.avatar .mr-2 .flex-shrink-0 .js-jump-to-suggestion-avatar .d-none width="28" height="28"}
    In this repository
    All GitHub
    ↵
    Jump to
    ↵
-   [](){.no-underline .d-flex .flex-auto .flex-items-center .jump-to-suggestions-path .js-jump-to-suggestion-path .js-navigation-open .p-2}
    ![](){.avatar .mr-2 .flex-shrink-0 .js-jump-to-suggestion-avatar .d-none width="28" height="28"}
    In this user
    All GitHub
    ↵
    Jump to
    ↵
-   [](){.no-underline .d-flex .flex-auto .flex-items-center .jump-to-suggestions-path .js-jump-to-suggestion-path .js-navigation-open .p-2}
    ![](){.avatar .mr-2 .flex-shrink-0 .js-jump-to-suggestion-avatar .d-none width="28" height="28"}
    In this repository
    All GitHub
    ↵
    Jump to
    ↵

[Sign in](/login?return_to=https%3A%2F%2Fgithub.com%2Finfokiller%2Fconfig-public%2Fblob%2Fmaster%2F.config%2Fipython%2Fprofile_default%2Fstartup%2Fext%2Ffzf_history.py){.HeaderMenu-link .flex-shrink-0 .no-underline}

[Sign up](/signup?ref_cta=Sign+up&ref_loc=header+logged+out&ref_page=%2F%3Cuser-name%3E%2F%3Crepo-name%3E%2Fblob%2Fshow&source=header-repo&source_repo=infokiller%2Fconfig-public){.HeaderMenu-link .flex-shrink-0 .d-inline-block .no-underline .border .color-border-default .rounded .px-2 .py-1}

{{ message }}

[infokiller](/infokiller){.url .fn} / **[config-public](/infokiller/config-public)** Public {#infokiller-config-public-public .d-flex .flex-wrap .flex-items-center .wb-break-word .f3 .text-normal}
===========================================================================================

-   Notifications
-   Fork
    2
-   Star
    14

```{=html}
<!-- -->
```
-   Code
-   Issues
    0
-   Pull requests
    0
-   Actions
-   Projects
    0
-   Wiki
-   Security
-   Insights

More

-   [Code](/infokiller/config-public){.js-selected-navigation-item .selected .dropdown-item}
-   [Issues](/infokiller/config-public/issues){.js-selected-navigation-item .dropdown-item}
-   [Pull requests](/infokiller/config-public/pulls){.js-selected-navigation-item .dropdown-item}
-   [Actions](/infokiller/config-public/actions){.js-selected-navigation-item .dropdown-item}
-   [Projects](/infokiller/config-public/projects?type=beta){.js-selected-navigation-item .dropdown-item}
-   [Wiki](/infokiller/config-public/wiki){.js-selected-navigation-item .dropdown-item}
-   [Security](/infokiller/config-public/security){.js-selected-navigation-item .dropdown-item}
-   [Insights](/infokiller/config-public/pulse){.js-selected-navigation-item .dropdown-item}

[Permalink](/infokiller/config-public/blob/65c9524194df921c1f6efdab9aa3e244f01e22ed/.config/ipython/profile_default/startup/ext/fzf_history.py){.d-none .js-permalink-shortcut}

master

Switch branches/tags

Branches

Tags

Could not load branches

Nothing to show

{{ refName }}
default

[View all branches](/infokiller/config-public/branches)

Could not load tags

Nothing to show

{{ refName }}
default

[View all tags](/infokiller/config-public/tags)

[config-public](/infokiller/config-public)/[.config](/infokiller/config-public/tree/master/.config)/[ipython](/infokiller/config-public/tree/master/.config/ipython)/[profile\_default](/infokiller/config-public/tree/master/.config/ipython/profile_default)/[startup](/infokiller/config-public/tree/master/.config/ipython/profile_default/startup)/[ext](/infokiller/config-public/tree/master/.config/ipython/profile_default/startup/ext)/**fzf\_history.py**
/

Jump to

Code definitions

\_load\_pygments\_objects
Function

\_highlight\_code
Function

\_HistoryPreviewThread
Class

\_\_init\_\_
Function

run
Function

stop
Function

\_extract\_command
Function

\_encode\_to\_selection
Function

\_decode\_from\_selection
Function

\_send\_entry\_to\_fzf
Function

\_create\_preview\_fifos
Function

\_create\_fzf\_process
Function

\_get\_history\_from\_connection
Function

\_get\_command\_history
Function

select\_history\_line
Function

\_is\_using\_prompt\_toolkit
Function

Code navigation index up-to-date

[Go to file](/infokiller/config-public/find/master){.js-pjax-capture-input .btn .mr-2 .d-none .d-md-block}

-   [Go to file
    T](/infokiller/config-public/find/master){.dropdown-item .d-flex .flex-items-baseline}
-   Go to line
    L
-   Go to definition
    R
-   
-   Copy path
-   Copy permalink

This commit does not belong to any branch on this repository, and may belong to a fork outside of the repository.

 

 

Cannot retrieve contributors at this time

219 lines (181 sloc)
7.36 KB

[Raw](/infokiller/config-public/raw/master/.config/ipython/profile_default/startup/ext/fzf_history.py){#raw-url .js-permalink-replaceable-link .btn-sm .btn .BtnGroup-item}
[Blame](/infokiller/config-public/blame/master/.config/ipython/profile_default/startup/ext/fzf_history.py){.js-update-url-with-hash .js-permalink-replaceable-link .btn-sm .btn .BtnGroup-item}

-   [Open with Desktop](https://desktop.github.com){.dropdown-item .tooltipped .tooltipped-nw .js-remove-unless-platform}
-   [View raw](/infokiller/config-public/raw/master/.config/ipython/profile_default/startup/ext/fzf_history.py){.dropdown-item}
-   
-   [View blame](/infokiller/config-public/blame/master/.config/ipython/profile_default/startup/ext/fzf_history.py){.dropdown-item}

This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters.
[Learn more about bidirectional Unicode characters](https://github.co/hiddenchars)

[Show hidden characters](%7B%7B%20revealButtonHref%20%7D%7D){.btn-sm .btn}

  -- --------------------------------------------------------------------------------------
     \# pylint: disable=import-outside-toplevel
     \# pylint: disable=global-statement
     
     import datetime
     import errno
     import os
     import sqlite3
     import subprocess
     import sys
     import tempfile
     import threading
     from typing import Any, Callable, Generator, Tuple
     
     import IPython
     
     \# This startup file is also used by \`jupyter console\`, which doesn\'t use prompt
     \# toolkit, and may fail importing it.
     try:
     import prompt\_toolkit
     from prompt\_toolkit.keys import Keys
     \_KeyPressEvent = prompt\_toolkit.key\_binding.key\_processor.KeyPressEvent
     except (ImportError, ValueError):
     pass
     
     \_ENCODED\_NEWLINE = \'↵\'
     \_ENCODED\_NEWLINE\_HIGHLIGHT = \'\\x1b\[48;5;250m\\x1b\[38;5;255m\'
     \_ENCODED\_NEWLINE\_HIGHLIGHT\_RESET = \'\\x1b\[0m\'
     \_HIGHLIGHTED\_ENCODED\_NEWLINE = \'{}{}{}\'.format(
     \_ENCODED\_NEWLINE\_HIGHLIGHT, \_ENCODED\_NEWLINE,
     \_ENCODED\_NEWLINE\_HIGHLIGHT\_RESET)
     
     \_FZF\_PREVIEW\_SCRIPT = \'\'\'
     echo {+n} \> \"%s\"
     cat \-- \"%s\"
     \'\'\'
     
     \_PYGMENTS\_LEXER = None
     \_PYGMENTS\_STYLE = None
     \_PYGMENTS\_FORMATTER = None
     
     \# Time the entry was executed and the code executed.
     HistoryEntry = Tuple\[datetime.datetime, str\]
     
     
     def \_load\_pygments\_objects():
     import pygments
     global \_PYGMENTS\_LEXER, \_PYGMENTS\_STYLE, \_PYGMENTS\_FORMATTER
     try:
     \_PYGMENTS\_LEXER = pygments.lexers.get\_lexer\_by\_name(\'ipython3\')
     except pygments.lexers.ClassNotFound:
     \_PYGMENTS\_LEXER = pygments.lexers.get\_lexer\_by\_name(\'python3\')
     try:
     \_PYGMENTS\_STYLE = pygments.styles.get\_style\_by\_name(\'solarized-dark\')
     except pygments.styles.ClassNotFound:
     \_PYGMENTS\_STYLE = pygments.styles.get\_style\_by\_name(\'default\')
     try:
     \_PYGMENTS\_FORMATTER = pygments.formatters.get\_formatter\_by\_name(
     \'terminal16m\', style=\_PYGMENTS\_STYLE)
     except pygments.formatters.ClassNotFound:
     \_PYGMENTS\_STYLE = pygments.formatters.get\_formatter\_by\_name(
     \'terminal256\', style=\_PYGMENTS\_STYLE)
     
     
     def \_highlight\_code(code: str) -\> str:
     import pygments
     global \_PYGMENTS\_LEXER, \_PYGMENTS\_STYLE, \_PYGMENTS\_FORMATTER
     if \_PYGMENTS\_LEXER is None:
     \_load\_pygments\_objects()
     return pygments.highlight(code, \_PYGMENTS\_LEXER, \_PYGMENTS\_FORMATTER)
     
     
     class \_HistoryPreviewThread(threading.Thread):
     
     def \_\_init\_\_(self, fifo\_input\_path: str, fifo\_output\_path: str,
     history\_getter: Callable\[\[int\], Any\], \*\*kwargs):
     super().\_\_init\_\_(\*\*kwargs)
     self.fifo\_input\_path = fifo\_input\_path
     self.fifo\_output\_path = fifo\_output\_path
     self.history\_getter = history\_getter
     self.is\_done = threading.Event()
     
     def run(self) -\> None:
     while not self.is\_done.is\_set():
     with open(self.fifo\_input\_path) as fifo\_input:
     while not self.is\_done.is\_set():
     data = fifo\_input.read()
     if len(data) == 0:
     break
     indices = \[int(s) for s in data.split()\]
     entries = \[self.history\_getter(i)\[1\] for i in indices\]
     code = \'\\n\\n\'.join(entries)
     highlighted\_code = \_highlight\_code(code)
     with open(self.fifo\_output\_path, \'w\') as fifo\_output:
     fifo\_output.write(highlighted\_code)
     
     def stop(self):
     self.is\_done.set()
     with open(self.fifo\_input\_path, \'w\') as f:
     f.close()
     self.join()
     
     
     def \_extract\_command(fzf\_output):
     if not fzf\_output.strip():
     return \'\'
     return fzf\_output\[fzf\_output.index(\'\|\') + 1:\].strip()
     
     
     def \_encode\_to\_selection(code: str) -\> str:
     code = code.strip()
     return code.replace(\'\\n\', \_HIGHLIGHTED\_ENCODED\_NEWLINE)
     
     
     def \_decode\_from\_selection(code: str) -\> str:
     return code.replace(\_ENCODED\_NEWLINE, \'\\n\')
     
     
     def \_send\_entry\_to\_fzf(entry: HistoryEntry, fzf):
     code = \_encode\_to\_selection(entry\[1\])
     line = \'{:%Y-%m-%d %H:%M:%S} \| {}\\n\'.format(entry\[0\], code).encode(\'utf-8\')
     try:
     fzf.stdin.write(line)
     except IOError as e:
     if e.errno == errno.EPIPE:
     return
     
     
     def \_create\_preview\_fifos():
     fifo\_dir = tempfile.mkdtemp(prefix=\'ipython\_fzf\_hist\_\')
     fifo\_input\_path = os.path.join(fifo\_dir, \'input\')
     fifo\_output\_path = os.path.join(fifo\_dir, \'output\')
     os.mkfifo(fifo\_input\_path)
     os.mkfifo(fifo\_output\_path)
     return fifo\_input\_path, fifo\_output\_path
     
     
     def \_create\_fzf\_process(initial\_query, fifo\_input\_path, fifo\_output\_path):
     \# TODO: fzf-tmux launch time is sometimes 5x slower than fzf and the delay
     \# is noticable.
     \# TODO: add a file for fzf search history.
     return subprocess.Popen(\[
     \'fzf-tmux\',
     \'\--no-sort\',
     \'\--multi\',
     \'-n3..,..\',
     \'\--tiebreak=index\',
     \'\--ansi\',
     \'\--bind=ctrl-r:toggle-sort\',
     \'\--exact\',
     \'\--query={}\'.format(initial\_query),
     \'\--preview={}\'.format(\_FZF\_PREVIEW\_SCRIPT %
     (fifo\_input\_path, fifo\_output\_path)),
     \],
     stdin=subprocess.PIPE,
     stdout=subprocess.PIPE)
     
     
     def \_get\_history\_from\_connection(con) -\> Generator\[HistoryEntry, None, None\]:
     session\_to\_start\_time = {}
     for session, start\_time in con.execute(
     \'SELECT session, start FROM sessions\'):
     session\_to\_start\_time\[session\] = start\_time
     query = \'\'\'
     SELECT session, source\_raw FROM (
     SELECT session, source\_raw, rowid FROM history ORDER BY rowid DESC
     )
     \'\'\'
     for session, source\_raw in con.execute(query):
     yield (session\_to\_start\_time\[session\], source\_raw)
     
     
     def \_get\_command\_history(files=None) -\> Generator\[HistoryEntry, None, None\]:
     hist\_manager = IPython.get\_ipython().history\_manager
     if not files:
     files = \[hist\_manager.hist\_file\]
     for file in files:
     \# detect\_types causes timestamps to be returned as datetime objects.
     con = sqlite3.connect(file,
     detect\_types=sqlite3.PARSE\_DECLTYPES \|
     sqlite3.PARSE\_COLNAMES,
     \*\*hist\_manager.connection\_options)
     for entry in \_get\_history\_from\_connection(con):
     yield entry
     con.close()
     
     
     def select\_history\_line(event: \_KeyPressEvent, history\_files=None):
     fifo\_input\_path, fifo\_output\_path = \_create\_preview\_fifos()
     fzf = \_create\_fzf\_process(event.current\_buffer.text, fifo\_input\_path,
     fifo\_output\_path)
     history = \[\]
     preview\_thread = \_HistoryPreviewThread(fifo\_input\_path, fifo\_output\_path,
     lambda i: history\[i\])
     preview\_thread.start()
     for entry in \_get\_command\_history(history\_files):
     history.append(entry)
     \_send\_entry\_to\_fzf(entry, fzf)
     stdout, stderr = fzf.communicate()
     preview\_thread.stop()
     if fzf.returncode == 0:
     lines = \[\]
     for line in stdout.decode(\'utf-8\').split(\'\\n\'):
     if not line.strip():
     continue
     lines.append(\_decode\_from\_selection(\_extract\_command(line)))
     event.current\_buffer.document = prompt\_toolkit.document.Document(
     \'\\n\'.join(lines))
     \# The 130 error code is when the user exited fzf, which is not an error.
     elif fzf.returncode != 130:
     sys.stderr.write(str(stderr))
     
     
     def \_is\_using\_prompt\_toolkit():
     return hasattr(IPython.get\_ipython(), \'pt\_app\')
     
     
     if \_is\_using\_prompt\_toolkit():
     key\_bindings = IPython.get\_ipython().pt\_app.key\_bindings
     key\_bindings.add(Keys.ControlR, filter=True)(select\_history\_line)
  -- --------------------------------------------------------------------------------------

-   Copy lines
-   Copy permalink
-   [View git blame](/infokiller/config-public/blame/65c9524194df921c1f6efdab9aa3e244f01e22ed/.config/ipython/profile_default/startup/ext/fzf_history.py){#js-view-git-blame .dropdown-item .js-update-url-with-hash}
-   [Reference in new issue](/infokiller/config-public/issues/new){#js-new-issue .dropdown-item}

Go

-   © 2022 GitHub, Inc.

```{=html}
<!-- -->
```
-   [Terms](https://docs.github.com/en/github/site-policy/github-terms-of-service)
-   [Privacy](https://docs.github.com/en/github/site-policy/github-privacy-statement)
-   [Security](https://github.com/security)
-   [Status](https://www.githubstatus.com/)
-   [Docs](https://docs.github.com)
-   [Contact GitHub](https://support.github.com?tags=dotcom-footer)
-   [Pricing](https://github.com/pricing)
-   [API](https://docs.github.com)
-   [Training](https://services.github.com)
-   [Blog](https://github.blog)
-   [About](https://github.com/about)

You can't perform that action at this time.

You signed in with another tab or window. [Reload]() to refresh your session.
You signed out in another tab or window. [Reload]() to refresh your session.
